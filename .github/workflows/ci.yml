name: CI

on:
	push:
		branches: ["main"]
	pull_request:
		branches: ["main"]

jobs:
	frontend:
		name: Frontend Build
		runs-on: ubuntu-latest
		defaults:
			run:
				working-directory: rompiendoyprobando-main
		steps:
			- name: Checkout
				uses: actions/checkout@v4

			- name: Setup Node.js
				uses: actions/setup-node@v4
				with:
					node-version: 22
					cache: npm
					cache-dependency-path: rompiendoyprobando-main/package-lock.json

			- name: Install dependencies
				run: npm ci

			- name: Build Angular app
				run: npm run build -- --configuration production

			- name: Build Docker image
				run: docker build -t frontend-ci:latest .

	backend:
		name: Backend Test & Build
		runs-on: ubuntu-latest
		needs: frontend
		services:
			postgres:
				image: postgres:16-alpine
				env:
					POSTGRES_DB: farmaceutica_db
					POSTGRES_USER: postgres
					POSTGRES_PASSWORD: root
				ports:
					- 5432:5432
				options: >-
					--health-cmd "pg_isready -U postgres -d farmaceutica_db" --health-interval 10s --health-timeout 5s --health-retries 5
		defaults:
			run:
				working-directory: TF_V2
		steps:
			- name: Checkout
				uses: actions/checkout@v4

			- name: Setup Java
				uses: actions/setup-java@v4
				with:
					distribution: temurin
					java-version: 17
					cache: maven

			- name: Make Maven wrapper executable
				run: chmod +x mvnw

			- name: Run tests
				run: ./mvnw -B clean verify

			- name: Build Docker image
				run: docker build -t backend-ci:latest .